import{r as v,i as w,x as q,c as i,a as e,n as p,k as y,y as $,g as O,F as B,B as V,t as l,l as H,v as j,p as D,b as Q,o as c}from"./index-b-6tx6qQ.js";import{s as C,A as G}from"./request-FOn4UwqS.js";import{e as I,d as J}from"./user-DhAspG1o.js";import{E as K}from"./EditEmail-noM6IYva.js";import{_ as W}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{f as X}from"./base-B1x2bpfq.js";import"./el-button-3LcmKSGv.js";const Z=(_,d)=>C.get(`/auth/send-email/history/${_}`,{params:d}),ee=(_,d)=>C.patch(`/auth/send-email/history?history_id=${_}`,d),se=_=>C.get(`/auth/send-email/pending/${_}`),te={class:"mail-history-container"},ae={class:"search-bar"},ne={class:"history-list"},le=["onClick"],oe={class:"item-header"},ie={class:"subject"},ce={class:"date"},de={class:"item-content"},ue={class:"recipient"},re={key:0,class:"empty-tip"},ve={class:"pagination-container"},pe={class:"pagination"},_e=["disabled"],me={class:"page-numbers"},he=["disabled"],be={class:"modal-content"},ge={class:"detail-section"},ye={class:"detail-row"},fe={class:"detail-value"},ke={class:"detail-row"},we={class:"detail-value"},je={class:"detail-row"},Ce={class:"detail-value"},xe={class:"detail-row"},Ee={class:"detail-row"},Me={class:"detail-value"},$e={class:"content-section"},Be={class:"section-header"},Ve=["disabled"],He=["disabled"],De=["innerHTML"],Le={key:1,class:"edit-section"},Ae={key:0,class:"attachment-section"},Fe={class:"attachment-list"},Ne={class:"file-icon"},Te={class:"file-name"},Ue=["onClick"],Ye={__name:"MailHistory",setup(_){const d=v(0),x=v(0),L=v("receiver_name_search"),h=v([]),b=v(""),f=v(!1),t=v({}),u=v(!1),r=v({content:"",subject:""}),E=w(()=>["pending","failed"].includes(t.value?.status)),A=w(()=>({failed:["pending","failed"].includes(t.value?.status),success:t.value?.status==="success"})),F=w(()=>t.value?.attachments?.length>0),N=async o=>{try{await se(o),m(),X.success("邮件发送成功")}catch(s){console.log(s)}},m=async(o=0)=>{d.value=o;const s={skip:o*10,limit:10,global_search:!0};b.value&&(s.q=b.value);const a=await Z(L.value,s);x.value=a.data.pagination.total_pages,h.value=await Promise.all(a.data.items.map(async n=>{const g=await I("id",n.sender_id),S=n.attachments.split(",").filter(Boolean).map(k=>({id:k,name:k,url:`${G}/file/${k}/download`}));return{receiver_emails:n.receiver_emails.split(",").filter(Boolean),receiver_type:n.receiver_type,sender:g.data,content:n.content,sent_at:J(n.sent_at).format("YYYY-MM-DD HH:mm:ss"),id:n.id,receiver_names:n.receiver_names.split(",").filter(Boolean),subject:n.subject,attachments:S,status:n.status,reason:n.reason}})),console.log(h.value)};q(()=>{m()});const T=o=>{console.log(o),t.value={...o},f.value=!0,u.value=!1},M=()=>{f.value=!1},U=()=>{u.value=!0,r.value.content=t.value.content,r.value.subject=t.value.subject},Y=()=>{u.value=!1},R=async()=>{const o=t.value.attachments.map(n=>n.id);console.log(t.value);const s=new FormData,a={...r.value,receiver_type:t.value.receiver_type,receiver_emails:t.value.receiver_emails.join(","),receiver_names:t.value.receiver_names.join(","),attachments:o.join(",")};Object.entries(a).forEach(([n,g])=>{s.append(n,g)});try{await ee(t.value.id,a),t.value.subject=r.value.subject,t.value.content=r.value.content,t.value.status="pending",u.value=!1,m()}catch(n){console.error("保存失败:",n)}},z=o=>{const s=o.split(".").pop().toLowerCase();return{pdf:"📄",doc:"📝",docx:"📝",xls:"📊",xlsx:"📊",ppt:"📑",pptx:"📑",jpg:"🖼️",png:"🖼️",gif:"🖼️",zip:"🗄️",rar:"🗄️",txt:"📋"}[s]||"📎"},P=o=>{window.open(o.url,"_blank")};return(o,s)=>(c(),i("div",te,[s[15]||(s[15]=e("h1",null,"邮件发送历史记录",-1)),e("div",ae,[y(e("input",{"onUpdate:modelValue":s[0]||(s[0]=a=>b.value=a),placeholder:"搜索收件人",class:"search-input"},null,512),[[$,b.value]]),e("button",{onClick:s[1]||(s[1]=a=>m(d.value)),class:"refresh-btn"},s[7]||(s[7]=[e("span",{class:"icon"},"↻",-1),O(" 刷新 ")]))]),e("div",ne,[(c(!0),i(B,null,V(h.value,a=>(c(),i("div",{key:a.id,onClick:n=>T(a),class:"history-item"},[e("div",oe,[e("span",ie,l(a.subject),1),e("span",ce,l(a.sent_at),1)]),e("div",de,[e("span",ue,"收件人: "+l(a.receiver_names.join(",")),1),e("span",{class:D(["status",a.status])},l(a.status),3)])],8,le))),128)),h.value.length===0?(c(),i("div",re," 没有找到匹配的邮件记录 ")):p("",!0)]),e("div",ve,[e("div",pe,[e("button",{onClick:s[2]||(s[2]=a=>m(--d.value)),class:"page-btn prev-btn",disabled:d.value==0},"上一页",8,_e),e("div",me,l(d.value+1),1),e("button",{onClick:s[3]||(s[3]=a=>m(++d.value)),class:"page-btn next-btn",disabled:d.value+1>=x.value},"下一页",8,he)])]),f.value?(c(),i("div",{key:0,class:"modal-overlay",onClick:H(M,["self"])},[e("div",be,[e("button",{class:"close-btn",onClick:M},"×"),y(e("h2",null,l(t.value.subject),513),[[j,!u.value]]),y(e("input",{style:{width:"80%",height:"30px"},"onUpdate:modelValue":s[4]||(s[4]=a=>r.value.subject=a),type:"text"},null,512),[[j,u.value],[$,r.value.subject]]),e("div",ge,[e("div",ye,[s[8]||(s[8]=e("span",{class:"detail-label"},"发送时间:",-1)),e("span",fe,l(t.value.sent_at),1)]),e("div",ke,[s[9]||(s[9]=e("span",{class:"detail-label"},"发件人:",-1)),e("span",we,l(t.value.sender.username)+"<"+l(t.value.sender.email)+">",1)]),e("div",je,[s[10]||(s[10]=e("span",{class:"detail-label"},"收件人:",-1)),e("span",Ce,l(t.value.receiver_names.join(",")),1)]),e("div",xe,[s[11]||(s[11]=e("span",{class:"detail-label"},"状态:",-1)),e("span",{class:D(["detail-value",A.value])},l(t.value.status),3)]),y(e("div",Ee,[s[12]||(s[12]=e("span",{class:"detail-label"},"原因:",-1)),e("span",Me,l(t.value.reason),1)],512),[[j,t.value.status==="failed"]])]),e("div",$e,[e("div",Be,[s[13]||(s[13]=e("h3",null,"邮件内容",-1)),s[14]||(s[14]=e("div",{style:{flex:"1"}},null,-1)),E.value?(c(),i("button",{key:0,onClick:U,class:"edit-btn",disabled:u.value,style:{"margin-right":"5px"}}," 编辑 ",8,Ve)):p("",!0),E.value?(c(),i("button",{key:1,onClick:s[5]||(s[5]=a=>N(t.value.id)),class:"edit-btn",disabled:u.value,style:{"background-color":"hsl(113, 51%, 52%)"}}," 发送 ",8,He)):p("",!0)]),u.value?p("",!0):(c(),i("div",{key:0,class:"email-content",innerHTML:t.value.content},null,8,De)),u.value?(c(),i("div",Le,[Q(K,{type:!1,modelValue:r.value.content,"onUpdate:modelValue":s[6]||(s[6]=a=>r.value.content=a)},null,8,["modelValue"]),e("div",{class:"edit-actions"},[e("button",{onClick:R,class:"save-btn"},"保存更改"),e("button",{onClick:Y,class:"cancel-btn"},"取消")])])):p("",!0)]),F.value?(c(),i("div",Ae,[e("h3",null,"附件 ("+l(t.value.attachments.length)+")",1),e("div",Fe,[(c(!0),i(B,null,V(t.value.attachments,(a,n)=>(c(),i("div",{key:n,class:"attachment-item"},[e("span",Ne,l(z(a.name)),1),e("span",Te,l(a.name),1),e("button",{onClick:H(g=>P(a),["stop"]),class:"download-btn"},"下载",8,Ue)]))),128))])])):p("",!0)])])):p("",!0)]))}},Ie=W(Ye,[["__scopeId","data-v-27d64ae8"]]);export{Ie as default};
